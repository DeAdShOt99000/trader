<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Trader{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partials/user-card.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="{{ url_for('static', filename='js/base.js') }}" defer></script>
    {% block head %}
    {% endblock %}
</head>
<body>
    {% block nav %}
        <header>
            <nav class="{% block nav_search %}{% endblock %}">
                <a href="{{ url_for('index') }}" class="app-name">Trader</a>

                {% block search_location %}
                {% endblock %}

                <div class="all-links">
                    <a href="{{ url_for('sell') }}" class="nav-link">Sell</a>
                    <a href="{{ url_for('all_contacts') }}" class="nav-link">Chats <span class="unread-msgs"></span></a>
                    <a href="{{ url_for('my_items') }}" class="nav-link">My items</a>
                    <a href="{{ url_for('favourites') }}" class="nav-link">Favourites</a>
                </div>

                <div class="user-card-cont">
                    {% if current_user.is_authenticated %}
                        {% include 'partials/user-card.html' %}
                        <a href="{{ url_for('logout') }}" class="logout">Log out</a>
                    {% else %}
                        <div class="guest">@Guest</div>
                        <div class="login-signup">
                            <a href="{{ url_for('login') }}" class="login">Log in</a>
                            <a href="{{ url_for('signup') }}" class="signup">Sign up</a>
                        </div>
                    {% endif %}
                </div>

            </nav>
        </header>
        
    {% for category, message in get_flashed_messages(with_categories=true) %}
        <div class="{{ category }}-message">{{ message }}</div>
    {% endfor %}
    {% endblock %}

    {% block content %}
    {% endblock %}

    {% block unread_msgs_script %}
    {% if current_user.is_authenticated %}
    <script>
        (function(){
            const unreadMsgs = document.querySelector('.unread-msgs');
            
            let sameResponse;
            function checkUnread(){
                fetch('/all-contacts/check-unread-json')
                .then(response => response.json())
                .then(data => {
                if (sameResponse !== data['unread_chats']){
                    if (data['unread_chats']){
                        unreadMsgs.innerText = data['unread_chats'];
                        unreadMsgs.style.display = 'inline-flex';
                    } else {
                        unreadMsgs.style.display = 'none';
                    };
                    sameResponse = data['unread_chats'];
                };
            });
            
            setTimeout(checkUnread, 3000);
        };
        
        checkUnread();
    })()
    </script>
    {% endif %}
    {% endblock %}
</body>
</html>