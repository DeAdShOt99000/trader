<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Trader{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/partials/user-card.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="{{ url_for('static', filename='js/base.js') }}" defer></script>
    {% block head %}{% endblock %}
</head>
<body>
    {% block nav %}
        <header>
            <nav>
                <a href="{{ url_for('index') }}" class="app-name">Trader</a>

                <div class="all-links">
                    <a href="{{ url_for('sell') }}" class="nav-link {% block sell_page %}{% endblock %}" title="Sell">
                        <svg width="20px" height="20px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32" xml:space="preserve" fill="white" stroke="white"><g id="SVGRepo_bgCarrier" stroke-whiteidth="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <style type="text/css"> .linesandangles_een{fill:white;} </style> <path class="linesandangles_een" d="M30,13V7H2v6c1.657,0,3,1.343,3,3s-1.343,3-3,3v6h28v-6c-1.657,0-3-1.343-3-3S28.343,13,30,13z M28,20.582V23h-7v-2h-2v2H4v-2.418C5.764,19.81,7,18.046,7,16s-1.236-3.81-3-4.583V9h15v2h2V9h7v2.417 c-1.764,0.773-3,2.536-3,4.583S26.236,19.81,28,20.582z M19,12h2v2h-2V12z M19,15h2v2h-2V15z M19,18h2v2h-2V18z"></path> </g></svg>
                        <span>Sell</span>
                    </a>
                    <a href="{{ url_for('all_contacts') }}" class="nav-link {% block all_contacts_page %}{% endblock %}" title="Chats">
                        <svg height="20px" width="20px" fill="white" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 60 60" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M45.224,0.494H25.776c-5.654,0-10.719,3.243-13.185,8.158c0.717-0.094,1.443-0.159,2.185-0.159h19.448 C43.475,8.493,51,16.019,51,25.27v11.345c0,1.296-0.16,2.553-0.436,3.766C56.101,38.122,60,32.649,60,26.614V15.27 C60,7.122,53.372,0.494,45.224,0.494z"></path> <path d="M34.224,10.493H14.776C6.628,10.493,0,17.122,0,25.27v11.345c0,7.732,6.313,14.314,14,14.845v6.48 c0,0.893,0.602,1.566,1.4,1.566c0.379,0,0.751-0.163,1.047-0.46l1.521-1.521c3.89-3.89,9.151-6.032,14.813-6.032h1.443 C42.372,51.493,49,44.818,49,36.614V25.27C49,17.122,42.372,10.493,34.224,10.493z M19,22.506h11c0.552,0,1,0.447,1,1s-0.448,1-1,1 H19c-0.552,0-1-0.447-1-1S18.448,22.506,19,22.506z M35,38.506H14c-0.552,0-1-0.447-1-1s0.448-1,1-1h21c0.552,0,1,0.447,1,1 S35.552,38.506,35,38.506z M35,31.506H14c-0.552,0-1-0.447-1-1s0.448-1,1-1h21c0.552,0,1,0.447,1,1S35.552,31.506,35,31.506z"></path> </g> </g></svg>
                        <span>Chats <span class="unread-msgs"></span></span>
                    </a>
                    <a href="{{ url_for('active_items') }}" class="nav-link {% block my_items_page %}{% endblock %}" title="My items">
                        <svg fill="white" width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke="white"><g id="SVGRepo_bgCarrier" stroke-whiteidth="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M6.5,22 C4.01471863,22 2,19.9852814 2,17.5 C2,15.0147186 4.01471863,13 6.5,13 C8.98528137,13 11,15.0147186 11,17.5 C11,19.9852814 8.98528137,22 6.5,22 Z M17.5,22 C15.0147186,22 13,19.9852814 13,17.5 C13,15.0147186 15.0147186,13 17.5,13 C19.9852814,13 22,15.0147186 22,17.5 C22,19.9852814 19.9852814,22 17.5,22 Z M6.5,11 C4.01471863,11 2,8.98528137 2,6.5 C2,4.01471863 4.01471863,2 6.5,2 C8.98528137,2 11,4.01471863 11,6.5 C11,8.98528137 8.98528137,11 6.5,11 Z M17.5,11 C15.0147186,11 13,8.98528137 13,6.5 C13,4.01471863 15.0147186,2 17.5,2 C19.9852814,2 22,4.01471863 22,6.5 C22,8.98528137 19.9852814,11 17.5,11 Z M17.5,9 C18.8807119,9 20,7.88071187 20,6.5 C20,5.11928813 18.8807119,4 17.5,4 C16.1192881,4 15,5.11928813 15,6.5 C15,7.88071187 16.1192881,9 17.5,9 Z M6.5,9 C7.88071187,9 9,7.88071187 9,6.5 C9,5.11928813 7.88071187,4 6.5,4 C5.11928813,4 4,5.11928813 4,6.5 C4,7.88071187 5.11928813,9 6.5,9 Z M17.5,20 C18.8807119,20 20,18.8807119 20,17.5 C20,16.1192881 18.8807119,15 17.5,15 C16.1192881,15 15,16.1192881 15,17.5 C15,18.8807119 16.1192881,20 17.5,20 Z M6.5,20 C7.88071187,20 9,18.8807119 9,17.5 C9,16.1192881 7.88071187,15 6.5,15 C5.11928813,15 4,16.1192881 4,17.5 C4,18.8807119 5.11928813,20 6.5,20 Z"></path> </g></svg>
                        <span>My items</span>
                    </a>
                    <a href="{{ url_for('favourites') }}" class="nav-link {% block favourites_page %}{% endblock %}" title="Favourites">
                        <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6.00019C10.2006 3.90317 7.19377 3.2551 4.93923 5.17534C2.68468 7.09558 2.36727 10.3061 4.13778 12.5772C5.60984 14.4654 10.0648 18.4479 11.5249 19.7369C11.6882 19.8811 11.7699 19.9532 11.8652 19.9815C11.9483 20.0062 12.0393 20.0062 12.1225 19.9815C12.2178 19.9532 12.2994 19.8811 12.4628 19.7369C13.9229 18.4479 18.3778 14.4654 19.8499 12.5772C21.6204 10.3061 21.3417 7.07538 19.0484 5.17534C16.7551 3.2753 13.7994 3.90317 12 6.00019Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                        <span>Favourites</span>
                    </a>
                </div>

                <div class="user-card-cont">
                    {% if current_user.is_authenticated %}
                        {% include 'partials/user-card.html' %}
                        <a href="{{ url_for('logout') }}" class="logout">Log out</a>
                    {% else %}
                        <div class="guest">@Guest</div>
                        <div class="login-signup">
                            <a href="{{ url_for('login') }}" class="login">Log in</a>
                            <a href="{{ url_for('signup') }}" class="signup">Sign up</a>
                        </div>
                    {% endif %}
                </div>
            </nav>
            
            {% block search_location %}{% endblock search_location %}
        </header>
            
        {% for category, message in get_flashed_messages(with_categories=true) %}
            <div class="{{ category }}-message">{{ message }}</div>
        {% endfor %}

    {% endblock nav %}

    {% block content %}{% endblock content %}

    {% block unread_msgs_script %}
        {% if current_user.is_authenticated %}
            <script>
                (function(){
                    // Getting element from the DOM
                    const unreadMsgs = document.querySelector('.unread-msgs');
                    
                    // Variable for checking if the response was the same (for checking unread messages)
                    let sameResponse;

                    // Recursive function that checks if there are any new messages
                    function checkUnread(){
                        fetch('/all-contacts/check-unread-json')
                        .then(response => response.json())
                        .then(data => {
                            if (sameResponse !== data['unread_chats']){
                                if (data['unread_chats']){
                                    unreadMsgs.innerText = data['unread_chats'];
                                    unreadMsgs.style.display = 'inline-flex';
                                } else {
                                    unreadMsgs.style.display = 'none';
                                };
                                sameResponse = data['unread_chats'];
                            };
                        });

                        setTimeout(checkUnread, 3000);
                    };

                    checkUnread();
                })()
            </script>
        {% endif %}
    {% endblock unread_msgs_script %}
</body>
</html>